# Generate a dsc file as used on grid'5000 by kaenv

- dashes: "---" # kameleon eats my dash if I don't use this dirty hack :-(
- tar_out_opts: numericowner:true excludes:"./etc/fstab ./tmp/*"

- save_as_tgz:
  - check_cmd_local: guestfish
  - check_cmd_local: gzip
  - exec_local: echo "Exporting appliance to $$output.tgz"
  - exec_local: LIBGUESTFS_CACHEDIR=$$kameleon_cwd guestfish --ro -i tar-out -a $$input / - $$tar_out_opts | gzip --best > $$output.tgz

- generate_dsc:
  - exec_local: echo "Creating description file for kaenv in $$output.dsc"
  - exec_local: |
      cat << EOF > $$output.dsc
      $${dashes}
      name: $${os_release}-x64-$$variant
      version: 0
      description: $$os_family $$os_release $$variant
      author: support-staff@lists.grid5000.fr
      visibility: public
      destructive: false
      os: linux
      image:
        file: server:///grid5000/images/$${os_release}-x64-min.tgz
        kind: tar
        compression: gzip
      postinstalls:
      - archive: server:///grid5000/postinstalls/$${os_family}-x64-min-post.tgz
        compression: gzip
        script: traitement.ash /rambin
      boot:
        kernel: /vmlinuz
        initrd: /initrd.img
      filesystem: ext4
      partition_type: 131
      multipart: false
      EOF
