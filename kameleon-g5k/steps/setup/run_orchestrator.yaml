# Provision a VM by launching a puppet agent (standalone)
- puppet_build_path: "/tmp/puppet_recipes"
- hiera_path: "/tmp/hiera"
- puppet_path: "/opt/puppetlabs/bin"
- puppet_local_path: $$kameleon_data_dir/puppet
- hiera_local_path: $$kameleon_data_dir/hiera


- import_puppet_recipes:
  - exec_in: mkdir -p $$puppet_build_path
  - pipe:
    - exec_local: tar -cf - -C $$puppet_local_path .
    - exec_in: tar xfp - -C $$puppet_build_path
- import_hiera:
  - exec_in: mkdir -p $$hiera_path
  - pipe:
    - exec_local: tar -cf - -C $$hiera_local_path .
    - exec_in: tar xfp - -C $$hiera_path
  - exec_in: $$puppet_path/puppet config set hiera_config $$hiera_path/hiera.yaml
- run_puppet:
  - exec_in: |
      if [ -z "$$variant" ]; then
        VARIANT=prod
      else
        VARIANT=$$variant
      fi
  - exec_in: $$puppet_path/puppet apply -d --modulepath=$$puppet_build_path/modules:/etc/puppetlabs/code/environments/production/modules $$puppet_build_path/manifests/$VARIANT.pp | tee /tmp/puppet_exec.log
