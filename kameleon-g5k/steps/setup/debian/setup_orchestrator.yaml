# Install and configure (if required) puppet
# This is not made by the standard packet installation mechanisme
# because we want to add a clean step

# - pkgmgr: apt-get
# - pkgmgr_yes: -y --force-yes
# - pkgmgr_install: install
# - pkgmgr_deinstall: autoremove
# - pkgmgr_purge: --purge
# - provisioning_packages: 'puppet'
#
# - setup_standalone_puppet:
#   - exec_in: $$pkgmgr $$pkgmgr_yes $$pkgmgr_install $$provisioning_packages
#   - on_setup_clean:
#     - exec_in: $$pkgmgr $$pkgmgr_yes $$pkgmgr_purge $$pkgmgr_deinstall $$provisioning_packages

- script_url: https://raw.githubusercontent.com/pmorillon/puppet-puppet/master/extras/bootstrap/puppet_install.sh
- script_name: puppet_install.sh
- script_path: /tmp
- puppet_version: 3.7.3

- get_standalone_puppet_script:
  - exec_local: mkdir -p $$kameleon_cwd/script_dir
  - exec_local: wget $$script_url --no-check-certificate -P $$kameleon_cwd/script_dir
  - pipe:
    - exec_local: tar -cf - -C $$kameleon_cwd/script_dir .
    - exec_in: tar xfp - -C $$script_path
  - exec_in: chmod +x $$script_path/$$script_name
  - exec_in: sed -e "/(cd \/tmp &&/i \ \ if [[ \$DISTRIB_CODENAME = 'jessie' ]]\n  then\n    DISTRIB_CODENAME=wheezy\n  fi" -i $$script_path/$$script_name
  - exec_in: PUPPET_VERSION=$$puppet_version $$script_path/$$script_name
  - on_setup_clean:
    - exec_local: rm -r $$kameleon_cwd/script_dir
