- insecure_ssh_key: $$kameleon_cwd/insecure_ssh_key

- download_boot2kameleon_iso:
  - download_file_local:
    - $$boot2kameleon_url
    - $$kameleon_cwd/boot2kameleon.iso

- create_initial_image:
  - check_cmd_local: qemu-img
  - exec_local: |
      rm -f $$qemu_image_disk
      qemu-img create -f qcow2 $$qemu_image_disk $$qemu_image_size

  - on_export_init:
    - check_cmd_local: guestfish
    - exec_local: echo -e "run\nzerofree /dev/sda1" | guestfish -a $$qemu_image_disk

- delete_initial_image:
  - on_checkpoint: skip
  - on_export_clean:
    - exec_local: rm -f $$qemu_image_disk

- generate_ssh_keys:
  - check_cmd_local: ssh-keygen
  - exec_local: echo -e  'y\n' | ssh-keygen -q -t rsa -b 4096 -f $$insecure_ssh_key -N ''
  - exec_local: cat $$insecure_ssh_key
  - exec_local: chmod 600 $$insecure_ssh_key

- create_ssh_config:
  - on_checkpoint: redo
  - exec_local: |
      # Find empty SSH forwarding port
      SSH_FWD_PORT=$(__find_free_port 50000 60000)
      echo "SSH forwarding port: $SSH_FWD_PORT"

  - write_local:
    - $$ssh_config_file
    - |
      Host $${kameleon_recipe_name}
      HostName 127.0.0.1
      Port $SSH_FWD_PORT
      User root
      IdentityFile $$insecure_ssh_key
      IdentityFile $$insecure_ssh_key
      UserKnownHostsFile /dev/null
      StrictHostKeyChecking no
      PasswordAuthentication no
      IdentitiesOnly yes
      LogLevel FATAL
      ForwardAgent yes
      Compression yes
      Protocol 2
